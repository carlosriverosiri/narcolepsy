---
// src/pages/diseases/[...slug].astro
import BaseLayout from "../../layouts/BaseLayout.astro";
import { useTranslations } from "../../i18n";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const diseases = await getCollection('diseases', ({ data }) => data.lang === 'en' && !data.draft);
  return diseases.map((disease) => ({
    params: { slug: disease.slug },
    props: { disease },
  }));
}

const { disease } = Astro.props;
const { Content } = await disease.render();
const t = useTranslations('en');

// Get related diseases if specified
const allDiseases = await getCollection('diseases', ({ data }) => data.lang === 'en');
const relatedDiseases = disease.data.relatedDiseases 
  ? allDiseases.filter(d => disease.data.relatedDiseases?.includes(d.slug))
  : [];

const categoryColors: Record<string, string> = {
  autoimmune: 'bg-purple-100 text-purple-800 border-purple-200',
  sleep: 'bg-indigo-100 text-indigo-800 border-indigo-200',
  infectious: 'bg-rose-100 text-rose-800 border-rose-200',
  storage: 'bg-amber-100 text-amber-800 border-amber-200',
  neurodegenerative: 'bg-slate-100 text-slate-800 border-slate-200',
  other: 'bg-gray-100 text-gray-800 border-gray-200',
};
---

<BaseLayout 
  title={disease.data.title}
  description={disease.data.description}
  type="article"
>
  <article>
    <!-- Hero -->
    <section class="bg-gradient-to-b from-slate-900 to-slate-800 text-white py-12">
      <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <nav class="text-sm text-slate-400 mb-4">
          <a href="/" class="hover:text-white transition-colors">Home</a>
          <span class="mx-2">/</span>
          <a href="/diseases/" class="hover:text-white transition-colors">Diseases</a>
          <span class="mx-2">/</span>
          <span class="text-white">{disease.data.title}</span>
        </nav>
        
        <div class="flex flex-wrap gap-3 mb-4">
          <span class={`text-xs font-medium px-3 py-1 rounded-full border ${categoryColors[disease.data.category]}`}>
            {disease.data.category.charAt(0).toUpperCase() + disease.data.category.slice(1)}
          </span>
          {disease.data.icd10 && (
            <span class="text-xs font-mono bg-slate-700 text-slate-300 px-3 py-1 rounded-full">
              ICD-10: {disease.data.icd10}
            </span>
          )}
        </div>
        
        <h1 class="text-3xl md:text-4xl font-bold mb-4">{disease.data.title}</h1>
        <p class="text-lg text-slate-300">{disease.data.description}</p>
      </div>
    </section>

    <!-- Quick Facts Sidebar + Content -->
    <section class="py-12">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="lg:grid lg:grid-cols-3 lg:gap-12">
          
          <!-- Quick Facts (Sidebar) -->
          <aside class="lg:col-span-1 mb-8 lg:mb-0">
            <div class="bg-slate-50 rounded-xl p-6 sticky top-24">
              <h3 class="font-bold text-slate-900 mb-4 flex items-center gap-2">
                <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Quick Facts
              </h3>
              
              {/* Gangliosides */}
              {disease.data.gangliosides && disease.data.gangliosides.length > 0 && (
                <div class="mb-4">
                  <h4 class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Target Gangliosides</h4>
                  <div class="flex flex-wrap gap-2">
                    {disease.data.gangliosides.map(g => (
                      <a 
                        href={`/science/gangliosides/?highlight=${g}`}
                        class="text-sm font-mono bg-red-50 text-red-700 px-3 py-1 rounded-full border border-red-200 hover:bg-red-100 transition-colors"
                      >
                        {g.toUpperCase()}
                      </a>
                    ))}
                  </div>
                </div>
              )}
              
              {/* Antibodies */}
              {disease.data.antibodies && disease.data.antibodies.length > 0 && (
                <div class="mb-4">
                  <h4 class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Antibodies</h4>
                  <div class="flex flex-wrap gap-2">
                    {disease.data.antibodies.map(ab => (
                      <span class="text-sm bg-purple-50 text-purple-700 px-3 py-1 rounded-full border border-purple-200">
                        {ab}
                      </span>
                    ))}
                  </div>
                </div>
              )}
              
              {/* Triggers */}
              {disease.data.triggers && disease.data.triggers.length > 0 && (
                <div class="mb-4">
                  <h4 class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Triggers</h4>
                  <ul class="text-sm text-slate-700 space-y-1">
                    {disease.data.triggers.map(trigger => (
                      <li class="flex items-start gap-2">
                        <span class="text-amber-500 mt-1">•</span>
                        {trigger}
                      </li>
                    ))}
                  </ul>
                </div>
              )}
              
              {/* Prognosis */}
              {disease.data.prognosis && (
                <div class="mb-4">
                  <h4 class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Prognosis</h4>
                  <p class="text-sm text-slate-700">{disease.data.prognosis}</p>
                </div>
              )}
              
              {/* Key Symptoms */}
              {disease.data.symptoms && disease.data.symptoms.length > 0 && (
                <div class="mb-4">
                  <h4 class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">Key Symptoms</h4>
                  <ul class="text-sm text-slate-700 space-y-1">
                    {disease.data.symptoms.map(symptom => (
                      <li class="flex items-start gap-2">
                        <span class="text-blue-500 mt-1">✓</span>
                        {symptom}
                      </li>
                    ))}
                  </ul>
                </div>
              )}
              
              {/* External Links */}
              <div class="border-t border-slate-200 pt-4 mt-4">
                <h4 class="text-xs font-semibold text-slate-500 uppercase tracking-wide mb-2">External Resources</h4>
                <div class="flex flex-col gap-2 text-sm">
                  {disease.data.omim && (
                    <a 
                      href={`https://omim.org/entry/${disease.data.omim}`}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="text-blue-600 hover:underline flex items-center gap-1"
                    >
                      OMIM #{disease.data.omim}
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                      </svg>
                    </a>
                  )}
                  {disease.data.orpha && (
                    <a 
                      href={`https://www.orpha.net/en/disease/detail/${disease.data.orpha}`}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="text-blue-600 hover:underline flex items-center gap-1"
                    >
                      Orphanet
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                      </svg>
                    </a>
                  )}
                </div>
              </div>
            </div>
          </aside>
          
          <!-- Main Content -->
          <div class="lg:col-span-2">
            <div class="prose prose-slate max-w-none prose-headings:font-bold prose-a:text-blue-600">
              <Content />
            </div>
            
            {/* Related Diseases */}
            {relatedDiseases.length > 0 && (
              <div class="mt-12 pt-8 border-t border-slate-200">
                <h3 class="text-lg font-bold text-slate-900 mb-4">Related Conditions</h3>
                <div class="grid sm:grid-cols-2 gap-4">
                  {relatedDiseases.map(related => (
                    <a 
                      href={`/diseases/${related.slug}/`}
                      class="block p-4 bg-slate-50 rounded-lg hover:bg-slate-100 transition-colors"
                    >
                      <h4 class="font-medium text-slate-900">{related.data.title}</h4>
                      <p class="text-sm text-slate-500 line-clamp-2">{related.data.description}</p>
                    </a>
                  ))}
                </div>
              </div>
            )}

            {/* Differential Diagnosis */}
            {disease.data.differentialDiagnosis && disease.data.differentialDiagnosis.length > 0 && (
              <div class="mt-8 p-6 bg-amber-50 rounded-xl border border-amber-200">
                <h3 class="text-lg font-bold text-amber-900 mb-3 flex items-center gap-2">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                  </svg>
                  Differential Diagnosis
                </h3>
                <p class="text-sm text-amber-800">Consider ruling out:</p>
                <ul class="mt-2 space-y-1">
                  {disease.data.differentialDiagnosis.map(ddx => (
                    <li class="text-sm text-amber-900 flex items-center gap-2">
                      <span>•</span> {ddx}
                    </li>
                  ))}
                </ul>
              </div>
            )}
          </div>
        </div>
      </div>
    </section>
  </article>
</BaseLayout>
