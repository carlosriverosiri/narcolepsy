---
// src/layouts/BaseLayout.astro
import "../styles/global.css";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import { getLangFromUrl, useTranslations, getAlternateUrls, isRtl, languages, type Lang } from "../i18n";

interface Props {
  title: string;
  description?: string;
  image?: string;
  type?: 'website' | 'article';
  noindex?: boolean;
}

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const rtl = isRtl(lang);
const alternateUrls = getAlternateUrls(Astro.url);

const { 
  title,
  description = t.site.description,
  image = "/images/og-image.jpg",
  type = "website",
  noindex = false,
} = Astro.props;

const siteUrl = "https://narcolepsy-hypothesis.com";
const canonicalUrl = new URL(Astro.url.pathname, siteUrl).href;
const ogImage = image.startsWith('http') ? image : `${siteUrl}${image}`;

// Locale mapping for Open Graph
const localeMap: Record<Lang, string> = {
  en: 'en_US',
  sv: 'sv_SE',
  de: 'de_DE',
  fr: 'fr_FR',
  es: 'es_ES',
  it: 'it_IT',
  nl: 'nl_NL',
  pl: 'pl_PL',
  pt: 'pt_PT',
  ar: 'ar_SA',
};
---

<!doctype html>
<html lang={lang} dir={rtl ? 'rtl' : 'ltr'}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title} | {t.site.title}</title>
    
    <!-- SEO Meta -->
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalUrl} />
    {noindex && <meta name="robots" content="noindex, nofollow" />}
    <meta name="author" content="Narcolepsy Hypothesis Research" />
    
    <!-- Hreflang for multilingual SEO -->
    {Object.entries(alternateUrls).map(([code, path]) => (
      <link rel="alternate" hreflang={code} href={`${siteUrl}${path}`} />
    ))}
    <link rel="alternate" hreflang="x-default" href={`${siteUrl}${alternateUrls.en}`} />
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content={type} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:locale" content={localeMap[lang]} />
    {Object.entries(localeMap).filter(([code]) => code !== lang).map(([_, locale]) => (
      <meta property="og:locale:alternate" content={locale} />
    ))}
    <meta property="og:site_name" content={t.site.title} />
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />
    
    <!-- Fonts - Inter for Latin, Noto Sans Arabic for RTL -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+Arabic:wght@400;500;600;700&display=swap"
      rel="stylesheet"
      media="print"
      onload="this.media='all'"
    />
    <noscript>
      <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+Arabic:wght@400;500;600;700&display=swap" rel="stylesheet" />
    </noscript>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    
    <!-- Theme color - Scientific blue -->
    <meta name="theme-color" content="#1e3a5f" />
    
    <!-- Alpine.js for interactive components -->
    <script is:inline defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <slot name="head" />
  </head>
  <body class:list={[
    "bg-slate-50 text-slate-800 min-h-screen flex flex-col",
    rtl ? "font-arabic" : "font-sans"
  ]}>
    <Header />
    
    <main class="flex-grow">
      <slot />
    </main>
    
    <Footer />
    
    <!-- Back to top button -->
    <button 
      id="back-to-top" 
      class="back-to-top" 
      aria-label={t.footer.back_to_top}
      title={t.footer.back_to_top}
    >
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
      </svg>
    </button>
    
    <script is:inline>
      // Back to top functionality
      const backToTop = document.getElementById('back-to-top');
      
      window.addEventListener('scroll', () => {
        if (window.scrollY > 300) {
          backToTop?.classList.add('visible');
        } else {
          backToTop?.classList.remove('visible');
        }
      });
      
      backToTop?.addEventListener('click', () => {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    </script>
  </body>
</html>
